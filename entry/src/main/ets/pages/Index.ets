import { CalendarView } from '../components/CalendarView'
import { EventCard } from '../components/EventCard'
import { Event, EventCategory, EventStatus } from '../models/Event'
import { EventService } from '../services/EventService'

@Entry
@Component
struct Index {
  @State currentTab: number = 0
  @State selectedDate: Date = new Date()
  @State todayEvents: Event[] = []
  @State allEvents: Event[] = []
  private eventService = EventService.getInstance()

  aboutToAppear() {
    this.loadMockData()
    this.loadTodayEvents()
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Text('ç¤¾åŒºä¹‹æ˜Ÿ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
        
        Button('åˆ›å»ºæ´»åŠ¨')
          .fontSize(14)
          .height(32)
          .backgroundColor('#007AFF')
          .onClick(() => {
            // è·³è½¬åˆ°åˆ›å»ºæ´»åŠ¨é¡µé¢
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#FFFFFF')

      // Tabåˆ‡æ¢
      Tabs({ barPosition: BarPosition.Start }) {
        TabContent() {
          this.StarTab()
        }.tabBar('æ˜æ˜Ÿ')

        TabContent() {
          this.CalendarTab()
        }.tabBar('æ—¥å†')

        TabContent() {
          this.EventListTab()
        }.tabBar('æ´»åŠ¨')

        TabContent() {
          this.ProfileTab()
        }.tabBar('æˆ‘çš„')
      }
      .layoutWeight(1)
      .onChange((index: number) => {
        this.currentTab = index
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder CalendarTab() {
    Column() {
      CalendarView({
        onDateSelect: (date: Date) => {
          this.selectedDate = date
          this.loadEventsByDate(date)
        }
      })
      
      // é€‰ä¸­æ—¥æœŸçš„æ´»åŠ¨åˆ—è¡¨
      if (this.todayEvents.length > 0) {
        Column() {
          Text(`${this.selectedDate.getMonth() + 1}æœˆ${this.selectedDate.getDate()}æ—¥çš„æ´»åŠ¨`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 12 })
          
          ForEach(this.todayEvents, (event: Event) => {
            EventCard({
              event: event,
              onJoin: (eventId: string) => {
                this.joinEvent(eventId)
              }
            })
              .margin({ bottom: 8 })
          })
        }
        .width('100%')
        .padding(16)
      } else {
        Column() {
          Text('è¿™ä¸€å¤©æ²¡æœ‰æ´»åŠ¨')
            .fontSize(14)
            .fontColor('#999')
            .margin({ top: 32 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder EventListTab() {
    List() {
      ForEach(this.allEvents, (event: Event) => {
        ListItem() {
          EventCard({
            event: event,
            onJoin: (eventId: string) => {
              this.joinEvent(eventId)
            }
          })
        }
        .margin({ left: 16, right: 16, top: 8, bottom: 8 })
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder StarTab() {
    Column() {
      // æ˜æ˜Ÿæ¦œå•æ ‡é¢˜
      Row() {
        Text('ğŸŒŸ ç¤¾åŒºæ˜æ˜Ÿæ¦œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
        
        Button('æåæ˜æ˜Ÿ')
          .fontSize(12)
          .height(28)
          .backgroundColor('#FF6B35')
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')

      // æ˜æ˜Ÿåˆ—è¡¨
      List() {
        ListItem() {
          this.StarCard('å¼ ä¸‰', 'HarmonyOSå¼€å‘ä¸“å®¶', 'è´¡çŒ®äº†15ä¸ªå¼€æºé¡¹ç›®', 'â­â­â­â­â­', '#FFD700')
        }
        ListItem() {
          this.StarCard('æå››', 'Vue.jsç¤¾åŒºæ´»è·ƒè€…', 'ç»„ç»‡äº†8åœºæŠ€æœ¯åˆ†äº«', 'â­â­â­â­', '#C0C0C0')
        }
        ListItem() {
          this.StarCard('ç‹äº”', 'å¼€æºæ–°æ˜Ÿ', 'å‚ä¸äº†å¤šä¸ªç¤¾åŒºé¡¹ç›®', 'â­â­â­', '#CD7F32')
        }
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }

  @Builder StarCard(name: string, title: string, achievement: string, stars: string, badgeColor: string) {
    Row() {
      // å¤´åƒ
      Circle({ width: 50, height: 50 })
        .fill('#E0E0E0')
        .margin({ right: 12 })
      
      // ä¿¡æ¯
      Column() {
        Row() {
          Text(name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
          
          Text(stars)
            .fontSize(14)
        }
        .width('100%')
        .margin({ bottom: 4 })
        
        Text(title)
          .fontSize(14)
          .fontColor('#007AFF')
          .margin({ bottom: 2 })
        
        Text(achievement)
          .fontSize(12)
          .fontColor('#666')
          .maxLines(2)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // å¾½ç« 
      Circle({ width: 8, height: 8 })
        .fill(badgeColor)
        .margin({ left: 8 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 8, bottom: 8 })
    .shadow({ radius: 2, color: '#1A000000', offsetX: 0, offsetY: 1 })
  }

  @Builder ProfileTab() {
    Column() {
      Text('ä¸ªäººä¸­å¿ƒå¼€å‘ä¸­...')
        .fontSize(16)
        .fontColor('#999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  private async loadMockData() {
    // åˆ›å»ºä¸€äº›æ¨¡æ‹Ÿæ•°æ®
    const event1 = new Event()
    event1.title = 'HarmonyOSå¼€å‘æŠ€æœ¯åˆ†äº«'
    event1.description = 'æ·±å…¥äº†è§£HarmonyOSåº”ç”¨å¼€å‘çš„æœ€ä½³å®è·µå’Œæ–°ç‰¹æ€§'
    event1.startTime = new Date(2025, 0, 15, 19, 0)
    event1.endTime = new Date(2025, 0, 15, 21, 0)
    event1.location = 'åŒ—äº¬å¸‚æœé˜³åŒºç§‘æŠ€å›­'
    event1.organizer = 'åä¸ºå¼€å‘è€…ç¤¾åŒº'
    event1.category = EventCategory.TECH_TALK
    event1.maxParticipants = 100
    event1.currentParticipants = 45
    event1.tags = ['HarmonyOS', 'ArkTS', 'ç§»åŠ¨å¼€å‘']
    event1.isOnline = false
    event1.status = EventStatus.UPCOMING

    const event2 = new Event()
    event2.title = 'Vue.js 3.0 å®æˆ˜å·¥ä½œåŠ'
    event2.description = 'ä»é›¶å¼€å§‹å­¦ä¹ Vue.js 3.0çš„ç»„åˆå¼APIå’Œæ–°ç‰¹æ€§'
    event2.startTime = new Date(2025, 0, 18, 14, 0)
    event2.endTime = new Date(2025, 0, 18, 17, 0)
    event2.location = 'çº¿ä¸Šç›´æ’­'
    event2.organizer = 'Vue.jsä¸­æ–‡ç¤¾åŒº'
    event2.category = EventCategory.WORKSHOP
    event2.maxParticipants = 200
    event2.currentParticipants = 156
    event2.tags = ['Vue.js', 'JavaScript', 'å‰ç«¯']
    event2.isOnline = true
    event2.meetingLink = 'https://meeting.example.com/vue-workshop'
    event2.status = EventStatus.UPCOMING

    await this.eventService.createEvent(event1)
    await this.eventService.createEvent(event2)
    
    this.allEvents = await this.eventService.getAllEvents()
  }

  private async loadTodayEvents() {
    this.todayEvents = await this.eventService.getEventsByDate(this.selectedDate)
  }

  private async loadEventsByDate(date: Date) {
    this.todayEvents = await this.eventService.getEventsByDate(date)
  }

  private async joinEvent(eventId: string) {
    const success = await this.eventService.joinEvent(eventId)
    if (success) {
      // åˆ·æ–°æ•°æ®
      this.allEvents = await this.eventService.getAllEvents()
      this.loadEventsByDate(this.selectedDate)
    }
  }
}